<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>åŸºé‡‘å‡€å€¼åˆ†é…è®¡ç®—å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
      color: #111827;
      background: #f3f4f6;
    }

    body {
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1080px;
      margin: 24px auto 40px;
      padding: 24px 16px;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #6b7280;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-title {
      font-weight: 600;
      margin-bottom: 0.8rem;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title span.icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #e5f0ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #1d4ed8;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
    }

    label {
      font-size: 0.85rem;
      color: #374151;
      display: block;
      margin-bottom: 4px;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }

    input::placeholder {
      color: #9ca3af;
    }

    input[readonly] {
      background: #f3f4f6;
      color: #4b5563;
    }

    .muted {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.9rem;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 0.8rem;
      color: #4b5563;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
      user-select: none;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      padding-inline: 8px;
      border-radius: 999px;
      font-size: 0.8rem;
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-icon {
      font-size: 1rem;
      line-height: 1;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .error {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #fef2f2;
      color: #b91c1c;
      font-size: 0.8rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 6px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .summary-item {
      padding: 8px 10px;
      border-radius: 10px;
      background: #f9fafb;
      font-size: 0.82rem;
    }

    .summary-label {
      color: #6b7280;
      margin-bottom: 2px;
    }

    .summary-value {
      font-weight: 600;
    }

    .summary-value.positive {
      color: #16a34a;
    }

    .summary-value.negative {
      color: #b91c1c;
    }

    .hidden {
      display: none;
    }

    .text-right {
      text-align: right;
    }

    .text-center {
      text-align: center;
    }

    .small {
      font-size: 0.8rem;
    }

    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .card {
        padding: 16px;
      }

      h1 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>åŸºé‡‘å‡€å€¼åˆ†é…è®¡ç®—å™¨</h1>
    <div class="subtitle">
      æŒ‰ã€ŒåŸºé‡‘å‡€å€¼ / ä»½é¢ã€æ–¹å¼ï¼Œè‡ªåŠ¨è®¡ç®—æœ¬æœŸæ”¶ç›Šåˆ†é…ä¸æ¯ä½æŠ•èµ„äººæœ€ç»ˆæƒç›Šã€‚
    </div>

    <!-- å…¨å±€è¾“å…¥ -->
    <div class="card">
      <div class="card-title">
        <span class="icon">â‘ </span> å…¨å±€å‚æ•°ï¼ˆè´¦æˆ·å±‚é¢ï¼‰
      </div>
      <div class="grid">
        <!-- ç¬¬ä¸€åˆ—ï¼šæœŸåˆè´¦æˆ·æ€»å€¼ / æŠ•èµ„äººæ€»æƒç›Š / å…¬å¸ç›ˆä½™ -->
        <div>
          <label for="accountStart">æœŸåˆè´¦æˆ·æ€»ä»·å€¼ï¼ˆUSDCï¼‰</label>
          <input id="accountStart" type="number" step="0.01" placeholder="ä¾‹å¦‚ 148719" />
          <div class="muted">åŒ…æ‹¬æŠ•èµ„äººæƒç›Š + å…¬å¸æƒç›Šç­‰æ€»å’Œ</div>

          <label for="initialInvestorTotal" style="margin-top:8px;">æœŸåˆæŠ•èµ„äººæ€»æƒç›Šï¼ˆUSDCï¼‰</label>
          <input id="initialInvestorTotal" type="number" step="0.01" readonly />
          <div class="muted">è‡ªåŠ¨ = ä¸‹æ–¹æ‰€æœ‰æŠ•èµ„äººæœŸåˆæƒç›Šä¹‹å’Œ</div>

          <label for="companySurplusStart" style="margin-top:8px;">æœŸåˆå…¬å¸ç›ˆä½™ï¼ˆUSDCï¼‰</label>
          <input id="companySurplusStart" type="number" step="0.01" readonly />
          <div class="muted">è‡ªåŠ¨ = æœŸåˆè´¦æˆ·æ€»ä»·å€¼ âˆ’ æœŸåˆæŠ•èµ„äººæ€»æƒç›Šï¼Œä»…å±•ç¤ºï¼Œä¸å‚ä¸æœ¬æœŸè®¡ç®—</div>
        </div>

        <!-- ç¬¬äºŒåˆ—ï¼šæœŸæœ«è´¦æˆ·æ€»å€¼ / è¿è¥æˆæœ¬ / æœŸæœ«ç»“ä½™ -->
        <div>
          <label for="accountEnd">æœŸæœ«è´¦æˆ·æ€»ä»·å€¼ï¼ˆUSDCï¼‰</label>
          <input id="accountEnd" type="number" step="0.01" placeholder="ä¾‹å¦‚ 159567" />

          <label for="costsFromPnl" style="margin-top:8px;">è¿è¥æˆæœ¬ï¼ˆUSDCï¼‰</label>
          <input id="costsFromPnl" type="number" step="0.01" value="0" />
          <div class="muted">ä¾‹å¦‚æœ¬æœŸ AWS ç­‰è¿è¥æˆæœ¬ï¼Œä»æœ¬æœŸæ”¶ç›Šä¸­æ‰£é™¤</div>

          <label for="endingBalance" style="margin-top:8px;">æœŸæœ«ç»“ä½™ï¼ˆUSDCï¼‰</label>
          <input id="endingBalance" type="number" step="0.01" readonly />
          <div class="muted">= æœŸæœ«è´¦æˆ·æ€»ä»·å€¼ âˆ’ è¿è¥æˆæœ¬</div>
        </div>

        <!-- ç¬¬ä¸‰åˆ—ï¼šå‡€ç›ˆåˆ© / æŠ•èµ„äººåˆ†æˆæ¯”ä¾‹ / æŠ•èµ„äººæ€»æ”¶ç›Š -->
        <div>
          <label for="netProfitDisplay">å‡€ç›ˆåˆ©ï¼ˆUSDCï¼‰</label>
          <input id="netProfitDisplay" type="number" step="0.01" readonly />
          <div class="muted">= æœŸæœ«ç»“ä½™ âˆ’ æœŸåˆè´¦æˆ·æ€»ä»·å€¼ï¼ˆå³æœ¬æœŸå¯åˆ†é…æ”¶ç›Šï¼‰</div>

          <label for="investorShare" style="margin-top:8px;">æŠ•èµ„äººåˆ†æˆæ¯”ä¾‹ï¼ˆ%ï¼‰</label>
          <input id="investorShare" type="number" step="0.01" value="50" />
          <div class="muted">ä¾‹å¦‚ 50 è¡¨ç¤ºå‡€ç›ˆåˆ©çš„ 50% ç»™æŠ•èµ„äººï¼Œå…¶ä½™ç»™å…¬å¸</div>

          <label for="investorProfitDisplay" style="margin-top:8px;">æŠ•èµ„äººæ€»æ”¶ç›Šï¼ˆUSDCï¼‰</label>
          <input id="investorProfitDisplay" type="number" step="0.01" readonly />
          <div class="muted">= å‡€ç›ˆåˆ© Ã— æŠ•èµ„äººåˆ†æˆæ¯”ä¾‹</div>
        </div>

        <!-- ç¬¬å››åˆ—ï¼šå…¬å¸å‡€æ”¶ç›Š / å·¥èµ„ / æ–°å…¬å¸ç›ˆä½™ -->
        <div>
          <label for="companyProfitDisplay">å…¬å¸å‡€æ”¶ç›Šï¼ˆUSDCï¼‰</label>
          <input id="companyProfitDisplay" type="number" step="0.01" readonly />
          <div class="muted">= å‡€ç›ˆåˆ© Ã— (1 âˆ’ æŠ•èµ„äººåˆ†æˆæ¯”ä¾‹)</div>

          <label for="companyWage" style="margin-top:8px;">æœ¬æœŸå…¬å¸å·¥èµ„ / å…¶ä»–å¼€é”€ï¼ˆUSDCï¼‰</label>
          <input id="companyWage" type="number" step="0.01" value="0" />
          <div class="muted">ç”¨äºä»å…¬å¸å‡€æ”¶ç›Šä¸­æ‰£é™¤ï¼Œä¸å½±å“æŠ•èµ„äººå‡€å€¼</div>

          <label for="companySurplusNewDisplay" style="margin-top:8px;">æ–°çš„å…¬å¸ç›ˆä½™ï¼ˆUSDCï¼‰</label>
          <input id="companySurplusNewDisplay" type="number" step="0.01" readonly />
          <div class="muted">= å…¬å¸å‡€æ”¶ç›Š âˆ’ å·¥èµ„ï¼Œæœ¬æœŸæ–°å¢å…¬å¸ç›ˆä½™ï¼ˆä¸å åŠ ä¸ŠæœŸï¼‰</div>
        </div>
      </div>
    </div>

    <!-- æŠ•èµ„äººè¡¨æ ¼ -->
    <div class="card">
      <div class="card-title">
        <span class="icon">â‘¡</span> æŠ•èµ„äººåˆ—è¡¨ï¼ˆåŸºé‡‘ä»½é¢ï¼‰
        <span class="badge">æœŸåˆ NAV çº¦å®šä¸º 1ï¼ŒæœŸåˆæƒç›Š = æœŸåˆä»½é¢</span>
      </div>
      <div class="muted">
        æ¯ä¸€æœŸçš„ã€ŒæœŸåˆæƒç›Šã€å¯ä»¥å¡«ä¸Šä¸€æœŸè®¡ç®—å‡ºçš„ã€Œæœ€ç»ˆæƒç›Šã€ã€‚æœ¬é¡µé¢ä¼šæŒ‰å½“å‰è¿™æœŸçš„ NAV åˆ†é…æ”¶ç›Šå¹¶å¤„ç†æ–°æŠ•å…¥ã€‚
      </div>

      <table id="investor-table">
        <thead>
          <tr>
            <th>å§“å / æ ‡è¯†</th>
            <th>æœŸåˆæƒç›Š<br/><span class="small">(USDC)</span></th>
            <th>æœ¬æœŸæ–°å¢æŠ•å…¥<br/><span class="small">(USDC)</span></th>
            <th class="text-center">åˆ é™¤</th>
          </tr>
        </thead>
        <tbody>
          <!-- é»˜è®¤è¡Œç”± JS æ³¨å…¥ï¼ˆç©ºè¡Œï¼‰ -->
        </tbody>
      </table>

      <div class="btn-row">
        <button class="btn btn-secondary" id="add-row-btn">
          <span class="btn-icon">ï¼‹</span> æ·»åŠ æŠ•èµ„äºº
        </button>
        <div class="muted">æç¤ºï¼šå¯éšæ—¶å¢åˆ è¡Œï¼Œç•™ç©ºçš„è¡Œä¸ä¼šå‚ä¸è®¡ç®—ã€‚</div>
      </div>
      <div id="investor-error" class="error hidden"></div>
    </div>

    <!-- è®¡ç®— & åˆ†äº« & å¯¼å‡º -->
    <div class="card">
      <div class="btn-row">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-primary" id="calc-btn">
            <span class="btn-icon">ğŸ§®</span> è®¡ç®—æœ¬æœŸåˆ†é…ç»“æœ
          </button>
          <button class="btn btn-secondary" id="share-btn">
            <span class="btn-icon">ğŸ”—</span> ç”Ÿæˆåˆ†äº«é“¾æ¥
          </button>
          <button class="btn btn-secondary" id="export-btn">
            <span class="btn-icon">ğŸ“„</span> å¯¼å‡ºæœ¬æ¬¡è®°å½•
          </button>
        </div>
        <div class="muted">
          æŒ‰å½“å‰è¾“å…¥ï¼Œä½¿ç”¨ã€ŒæœŸåˆä»½é¢ = æœŸåˆæƒç›Šï¼ŒæœŸæœ« NAV = (æœŸåˆæƒç›Šæ€»å’Œ + æŠ•èµ„äººæ”¶ç›Š) / æœŸåˆä»½é¢æ€»å’Œã€çš„æ–¹å¼è®¡ç®—ã€‚
        </div>
      </div>
      <div id="global-error" class="error hidden"></div>

      <div id="share-container" class="hidden" style="margin-top:10px;">
        <label style="font-size:0.8rem; color:#4b5563;">åˆ†äº«é“¾æ¥ï¼ˆå¤åˆ¶å‘ç»™æŠ•èµ„äººï¼‰ï¼š</label>
        <input id="share-link-input" type="text" readonly />
        <div class="muted">
          é“¾æ¥ä¸­å·²åŒ…å«å½“å‰é¡µé¢æ‰€æœ‰è¾“å…¥ä¿¡æ¯ï¼ŒæŠ•èµ„äººæ‰“å¼€åä¼šè‡ªåŠ¨æ¢å¤å¹¶è®¡ç®—ã€‚
        </div>
      </div>
    </div>

    <!-- ç»“æœå±•ç¤º -->
    <div id="result-card" class="card hidden">
      <div class="card-title">
        <span class="icon">â‘¢</span> è®¡ç®—ç»“æœ
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">æœŸåˆè´¦æˆ·æ€»ä»·å€¼</div>
          <div class="summary-value" id="summary-account-start"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æœŸæœ«è´¦æˆ·æ€»ä»·å€¼</div>
          <div class="summary-value" id="summary-account-end"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æœ¬æœŸæ¯›æ”¶ç›Š (è´¦æˆ·)</div>
          <div class="summary-value" id="summary-raw-pnl"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">è¿è¥æˆæœ¬</div>
          <div class="summary-value" id="summary-costs"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">å‡€ç›ˆåˆ©ï¼ˆå¯åˆ†é…æ”¶ç›Šï¼‰</div>
          <div class="summary-value" id="summary-distributable"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æŠ•èµ„äººæ€»æ”¶ç›Š</div>
          <div class="summary-value" id="summary-investor-profit"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">å…¬å¸å‡€æ”¶ç›Šï¼ˆåˆ†æˆï¼‰</div>
          <div class="summary-value" id="summary-company-profit"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æ–°çš„å…¬å¸ç›ˆä½™ï¼ˆæ‰£å·¥èµ„åï¼‰</div>
          <div class="summary-value" id="summary-company-net"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æœ¬æœŸåŸºé‡‘å•ä½å‡€å€¼ (NAV)</div>
          <div class="summary-value" id="summary-nav"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æœŸåˆæŠ•èµ„äººæ€»æƒç›Š</div>
          <div class="summary-value" id="summary-investor-start"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æ–°å¢æŠ•å…¥åˆè®¡</div>
          <div class="summary-value" id="summary-new-capital"></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">æœŸæœ«æŠ•èµ„äººæ€»æƒç›Š</div>
          <div class="summary-value" id="summary-investor-end"></div>
        </div>
      </div>

      <h3 style="margin-top: 16px; font-size: 1rem;">æŠ•èµ„äººæ˜ç»†</h3>
      <table>
        <thead>
          <tr>
            <th>å§“å</th>
            <th class="text-right">æœŸåˆæƒç›Š</th>
            <th class="text-right">åˆ†é…åˆ°çš„æ”¶ç›Š</th>
            <th class="text-right">æœ¬æœŸæ–°å¢æŠ•å…¥</th>
            <th class="text-right">æœŸæœ«æƒç›Š</th>
          </tr>
        </thead>
        <tbody id="result-body">
        </tbody>
      </table>
      <div class="muted" style="margin-top: 8px;">
        è¯´æ˜ï¼šæœŸåˆçº¦å®š NAV = 1ï¼Œå› æ­¤æœŸåˆæƒç›Š = æœŸåˆä»½é¢ã€‚<br/>
        æœ¬æœŸ NAV = (æœŸåˆæŠ•èµ„äººæ€»æƒç›Š + æŠ•èµ„äººæ”¶ç›Š) Ã· æœŸåˆä»½é¢æ€»æ•°ã€‚<br/>
        æ–°æŠ•å…¥æŒ‰æœ¬æœŸ NAV ç”³è´­æ–°ä»½é¢ï¼Œæœ€ç»ˆæƒç›Š = æœ€ç»ˆä»½é¢ Ã— æœ¬æœŸ NAVã€‚
      </div>
    </div>

    <div class="footer">
      ä½ å¯ä»¥æŠŠè¿™ä¸ª HTML æ–‡ä»¶æ”¾åˆ° GitHub Pages / Netlify ä¸Šï¼Œåˆ†äº«é“¾æ¥ç»™å…¶ä»–åˆä¼™äººç›´æ¥ä½¿ç”¨ã€‚
    </div>
  </div>

  <script>
    // å°å·¥å…·ï¼šå®‰å…¨è§£ææ•°å­—
    function parseNumber(value) {
      const n = parseFloat(value);
      return isNaN(n) ? 0 : n;
    }

    // æœ€è¿‘ä¸€æ¬¡è®¡ç®—çš„å®Œæ•´æ•°æ®ï¼Œç”¨äºå¯¼å‡ºè®°å½•
    let lastCalculationData = null;

    // æ·»åŠ ä¸€è¡ŒæŠ•èµ„äºº
    function addInvestorRow(name = "", initial = "", added = "") {
      const tbody = document.querySelector("#investor-table tbody");
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>
          <input type="text" placeholder="å§“å" value="${name}">
        </td>
        <td>
          <input type="number" step="0.01" placeholder="æœŸåˆæƒç›Š" value="${initial}">
        </td>
        <td>
          <input type="number" step="0.01" placeholder="æœ¬æœŸæ–°å¢æŠ•å…¥" value="${added}">
        </td>
        <td class="text-center">
          <button class="btn btn-danger" type="button">âœ•</button>
        </td>
      `;

      const deleteBtn = tr.querySelector("button");
      deleteBtn.addEventListener("click", () => {
        tr.remove();
      });

      tbody.appendChild(tr);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const addRowBtn = document.getElementById("add-row-btn");
      const calcBtn = document.getElementById("calc-btn");
      const shareBtn = document.getElementById("share-btn");
      const exportBtn = document.getElementById("export-btn");
      const investorError = document.getElementById("investor-error");
      const globalError = document.getElementById("global-error");
      const resultCard = document.getElementById("result-card");
      const shareContainer = document.getElementById("share-container");
      const shareLinkInput = document.getElementById("share-link-input");

      // å¯åŠ¨æ—¶å…ˆåŠ ä¸€è¡Œç©ºè¡Œï¼Œä½œä¸ºâ€œæ¨¡æ¿â€
      addInvestorRow();

      addRowBtn.addEventListener("click", () => {
        addInvestorRow();
      });

      function runCalculation() {
        investorError.classList.add("hidden");
        globalError.classList.add("hidden");
        resultCard.classList.add("hidden");
        lastCalculationData = null;

        // è¯»å–å…¨å±€å‚æ•°
        const accountStart = parseNumber(document.getElementById("accountStart").value);
        const accountEnd = parseNumber(document.getElementById("accountEnd").value);
        const costsFromPnl = parseNumber(document.getElementById("costsFromPnl").value);
        const investorSharePercent = parseNumber(document.getElementById("investorShare").value);
        const companyWage = parseNumber(document.getElementById("companyWage").value);

        if (accountStart === 0 || accountEnd === 0) {
          globalError.textContent = "è¯·å¡«å†™æœŸåˆå’ŒæœŸæœ«è´¦æˆ·æ€»ä»·å€¼ã€‚";
          globalError.classList.remove("hidden");
          return false;
        }

        if (investorSharePercent < 0 || investorSharePercent > 100) {
          globalError.textContent = "æŠ•èµ„äººåˆ†æˆæ¯”ä¾‹å¿…é¡»åœ¨ 0% ~ 100% ä¹‹é—´ã€‚";
          globalError.classList.remove("hidden");
          return false;
        }

        const investorShare = investorSharePercent / 100;

        // æ”¶é›†æŠ•èµ„äººæ•°æ®
        const rows = document.querySelectorAll("#investor-table tbody tr");
        const investors = [];
        rows.forEach((tr) => {
          const tds = tr.querySelectorAll("td");
          const name = tds[0].querySelector("input").value.trim();
          const initial = parseNumber(tds[1].querySelector("input").value);
          const added = parseNumber(tds[2].querySelector("input").value);

          // æ²¡åå­—å¹¶ä¸”ä¸¤ä¸ªé‡‘é¢éƒ½æ˜¯ 0 çš„è¡Œç›´æ¥å¿½ç•¥
          if (!name && initial === 0 && added === 0) {
            return;
          }

          investors.push({
            name,
            initial,
            added
          });
        });

        if (investors.length === 0) {
          investorError.textContent = "è¯·è‡³å°‘å¡«å†™ä¸€ä½æŠ•èµ„äººçš„æœŸåˆæƒç›Šã€‚";
          investorError.classList.remove("hidden");
          return false;
        }

        // è®¡ç®—æœŸåˆæŠ•èµ„äººæ€»æƒç›Š & æ–°æŠ•å…¥
        let totalInitialEquity = 0;
        let totalNewCapital = 0;
        investors.forEach((inv) => {
          totalInitialEquity += inv.initial;
          totalNewCapital += inv.added;
        });

        if (totalInitialEquity <= 0) {
          investorError.textContent = "æœŸåˆæŠ•èµ„äººæ€»æƒç›Šå¿…é¡»å¤§äº 0ã€‚";
          investorError.classList.remove("hidden");
          return false;
        }

        // è´¦æˆ·å±‚é¢æ”¶ç›Š
        const rawPnl = accountEnd - accountStart;           // æ¯›æ”¶ç›Š
        const distributable = rawPnl - costsFromPnl;        // å‡€ç›ˆåˆ©ï¼ˆå¯åˆ†é…æ”¶ç›Šï¼‰
        const investorProfit = distributable * investorShare;       // æŠ•èµ„äººæ€»æ”¶ç›Š
        const companyProfit = distributable * (1 - investorShare);  // å…¬å¸å‡€æ”¶ç›Šï¼ˆåˆ†æˆï¼‰
        const companyNet = companyProfit - companyWage;     // æ–°çš„å…¬å¸ç›ˆä½™ï¼ˆæ‰£å·¥èµ„ï¼‰

        // åŸºé‡‘ NAV
        const nav = (totalInitialEquity + investorProfit) / totalInitialEquity;

        // æœŸæœ«ç»“ä½™ & å‡€ç›ˆåˆ©
        const endingBalance = accountEnd - costsFromPnl;    // æœŸæœ«ç»“ä½™
        const netProfit = endingBalance - accountStart;     // = distributable

        // ====== å¡«å›åˆ°â€œå…¨å±€å‚æ•°â€åŒºåŸŸçš„åªè¯»æ¡† ======
        const fmt2Plain = (x) => x.toFixed(2);

        const initialInvestorTotalInput = document.getElementById("initialInvestorTotal");
        if (initialInvestorTotalInput) {
          initialInvestorTotalInput.value = fmt2Plain(totalInitialEquity);
        }

        const companySurplusStartVal = accountStart - totalInitialEquity;
        const companySurplusStartInput = document.getElementById("companySurplusStart");
        if (companySurplusStartInput) {
          companySurplusStartInput.value = fmt2Plain(companySurplusStartVal);
        }

        document.getElementById("endingBalance").value = fmt2Plain(endingBalance);
        document.getElementById("netProfitDisplay").value = fmt2Plain(netProfit);
        document.getElementById("investorProfitDisplay").value = fmt2Plain(investorProfit);
        document.getElementById("companyProfitDisplay").value = fmt2Plain(companyProfit);
        document.getElementById("companySurplusNewDisplay").value = fmt2Plain(companyNet);

        // é€ä¸ªæŠ•èµ„äººè®¡ç®—
        const resultRows = [];
        let totalEndEquity = 0;

        investors.forEach((inv) => {
          const weight = inv.initial / totalInitialEquity;
          const profitShare = investorProfit * weight; // åˆ†é…ç»™æ­¤äººçš„æœ¬æœŸæ”¶ç›Š
          const extraShares = inv.added / nav;         // æ–°å¢ä»½é¢
          const startShares = inv.initial;             // æœŸåˆ NAV=1
          const endShares = startShares + extraShares;
          const endEquity = endShares * nav;

          totalEndEquity += endEquity;

          resultRows.push({
            name: inv.name || "(æœªå‘½å)",
            initial: inv.initial,
            profitShare,
            added: inv.added,
            endEquity
          });
        });

        // ====== æ¸²æŸ“ç»“æœå¡ç‰‡ ======
        const fmt2Text = (x) => x.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmt4Text = (x) => x.toLocaleString("en-US", { minimumFractionDigits: 4, maximumFractionDigits: 4 });

        document.getElementById("summary-account-start").textContent = fmt2Text(accountStart);
        document.getElementById("summary-account-end").textContent = fmt2Text(accountEnd);

        const rawPnlEl = document.getElementById("summary-raw-pnl");
        rawPnlEl.textContent = fmt2Text(rawPnl);
        rawPnlEl.className = "summary-value " + (rawPnl >= 0 ? "positive" : "negative");

        document.getElementById("summary-costs").textContent = fmt2Text(costsFromPnl);

        const distEl = document.getElementById("summary-distributable");
        distEl.textContent = fmt2Text(distributable);
        distEl.className = "summary-value " + (distributable >= 0 ? "positive" : "negative");

        const invProfEl = document.getElementById("summary-investor-profit");
        invProfEl.textContent = fmt2Text(investorProfit);
        invProfEl.className = "summary-value " + (investorProfit >= 0 ? "positive" : "negative");

        const compProfEl = document.getElementById("summary-company-profit");
        compProfEl.textContent = fmt2Text(companyProfit);
        compProfEl.className = "summary-value " + (companyProfit >= 0 ? "positive" : "negative");

        const compNetEl = document.getElementById("summary-company-net");
        compNetEl.textContent = fmt2Text(companyNet);
        compNetEl.className = "summary-value " + (companyNet >= 0 ? "positive" : "negative");

        document.getElementById("summary-nav").textContent = fmt4Text(nav);
        document.getElementById("summary-investor-start").textContent = fmt2Text(totalInitialEquity);
        document.getElementById("summary-new-capital").textContent = fmt2Text(totalNewCapital);
        document.getElementById("summary-investor-end").textContent = fmt2Text(totalEndEquity);

        // æŠ•èµ„äººç»“æœè¡¨
        const tbody = document.getElementById("result-body");
        tbody.innerHTML = "";

        resultRows.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.name}</td>
            <td class="text-right">${fmt2Text(r.initial)}</td>
            <td class="text-right">${fmt2Text(r.profitShare)}</td>
            <td class="text-right">${fmt2Text(r.added)}</td>
            <td class="text-right">${fmt2Text(r.endEquity)}</td>
          `;
          tbody.appendChild(tr);
        });

        resultCard.classList.remove("hidden");

        // æŠŠæœ¬æ¬¡è®¡ç®—çš„æ•°æ®å­˜èµ·æ¥ï¼Œæ–¹ä¾¿å¯¼å‡º
        lastCalculationData = {
          timestamp: new Date().toISOString(),
          globals: {
            accountStart,
            accountEnd,
            costsFromPnl,
            investorSharePercent,
            companyWage,
            rawPnl,
            distributable,
            investorProfit,
            companyProfit,
            companyNet,
            endingBalance,
            netProfit,
            nav,
            totalInitialEquity,
            totalNewCapital,
            totalEndEquity,
            companySurplusStart: companySurplusStartVal
          },
          investors: resultRows
        };

        return true;
      }

      calcBtn.addEventListener("click", () => {
        runCalculation();
      });

      // ç”Ÿæˆåˆ†äº«é“¾æ¥ï¼šæŠŠå½“å‰è¾“å…¥æ‰“åŒ…åˆ° URL ?d=... ä¸­
      shareBtn.addEventListener("click", () => {
        // æ”¶é›†å…¨å±€å‚æ•°
        const accountStart = parseNumber(document.getElementById("accountStart").value);
        const accountEnd = parseNumber(document.getElementById("accountEnd").value);
        const costsFromPnl = parseNumber(document.getElementById("costsFromPnl").value);
        const investorSharePercent = parseNumber(document.getElementById("investorShare").value);
        const companyWage = parseNumber(document.getElementById("companyWage").value);

        // æ”¶é›†æŠ•èµ„äººæ•°æ®ï¼ˆå…è®¸ç©ºæ•°æ®ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼‰
        const rows = document.querySelectorAll("#investor-table tbody tr");
        const investors = [];
        rows.forEach((tr) => {
          const tds = tr.querySelectorAll("td");
          const name = tds[0].querySelector("input").value.trim();
          const initial = parseNumber(tds[1].querySelector("input").value);
          const added = parseNumber(tds[2].querySelector("input").value);

          if (!name && initial === 0 && added === 0) {
            return;
          }

          investors.push({
            name,
            initial,
            added
          });
        });

        const data = {
          accountStart,
          accountEnd,
          costsFromPnl,
          investorSharePercent,
          companyWage,
          investors
        };

        try {
          const json = JSON.stringify(data);
          const encoded = encodeURIComponent(json);
          // ç”¨ href å»æ‰åŸæœ‰ queryï¼Œæ›´é€šç”¨ï¼ˆæœ¬åœ° file:// å’Œ https:// éƒ½ OKï¼‰
          const base = window.location.href.split("?")[0];
          const url = `${base}?d=${encoded}`;
          shareLinkInput.value = url;
          shareContainer.classList.remove("hidden");
        } catch (e) {
          console.error("ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥", e);
          globalError.textContent = "ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥ï¼ˆJSON åºåˆ—åŒ–é”™è¯¯ï¼‰ã€‚";
          globalError.classList.remove("hidden");
        }
      });

      // å¯¼å‡ºæœ¬æ¬¡è®°å½•ä¸º txt æ–‡ä»¶
      exportBtn.addEventListener("click", () => {
        globalError.classList.add("hidden");
        if (!lastCalculationData) {
          globalError.textContent = "è¯·å…ˆç‚¹å‡»ã€Œè®¡ç®—æœ¬æœŸåˆ†é…ç»“æœã€ï¼Œå†å¯¼å‡ºè®°å½•ã€‚";
          globalError.classList.remove("hidden");
          return;
        }

        const d = lastCalculationData;
        const pad2 = (n) => String(n).padStart(2, "0");
        const dt = new Date(d.timestamp || Date.now());
        const tsStr = `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;
        const nf2 = (x) => x.toFixed(2);

        let text = "";
        text += "åŸºé‡‘ç»“ç®—è®°å½•\n";
        text += `æ—¶é—´: ${tsStr}\n\n`;

        const g = d.globals;
        text += "ã€å…¨å±€å‚æ•°ã€‘\n";
        text += `æœŸåˆè´¦æˆ·æ€»ä»·å€¼: ${nf2(g.accountStart)} USDC\n`;
        text += `æœŸæœ«è´¦æˆ·æ€»ä»·å€¼: ${nf2(g.accountEnd)} USDC\n`;
        text += `æœŸæœ«ç»“ä½™(æ‰£è¿è¥æˆæœ¬å): ${nf2(g.endingBalance)} USDC\n`;
        text += `è¿è¥æˆæœ¬: ${nf2(g.costsFromPnl)} USDC\n`;
        text += `å‡€ç›ˆåˆ©(å¯åˆ†é…æ”¶ç›Š): ${nf2(g.distributable)} USDC\n`;
        text += `æŠ•èµ„äººåˆ†æˆæ¯”ä¾‹: ${nf2(g.investorSharePercent)} %\n`;
        text += `æŠ•èµ„äººæ€»æ”¶ç›Š: ${nf2(g.investorProfit)} USDC\n`;
        text += `å…¬å¸å‡€æ”¶ç›Š(åˆ†æˆ): ${nf2(g.companyProfit)} USDC\n`;
        text += `æœ¬æœŸå…¬å¸å·¥èµ„/å…¶ä»–å¼€é”€: ${nf2(g.companyWage)} USDC\n`;
        text += `æ–°çš„å…¬å¸ç›ˆä½™(æ‰£å·¥èµ„å): ${nf2(g.companyNet)} USDC\n`;
        text += `æœŸåˆæŠ•èµ„äººæ€»æƒç›Š: ${nf2(g.totalInitialEquity)} USDC\n`;
        text += `æ–°å¢æŠ•å…¥åˆè®¡: ${nf2(g.totalNewCapital)} USDC\n`;
        text += `æœŸæœ«æŠ•èµ„äººæ€»æƒç›Š: ${nf2(g.totalEndEquity)} USDC\n`;
        text += `æœŸåˆå…¬å¸ç›ˆä½™: ${nf2(g.companySurplusStart)} USDC\n`;
        text += `åŸºé‡‘å•ä½å‡€å€¼(NAV): ${g.nav.toFixed(6)}\n`;
        text += "\n";

        text += "ã€æŠ•èµ„äººæ˜ç»†ã€‘\n";
        text += "å§“å, æœŸåˆæƒç›Š, åˆ†é…æ”¶ç›Š, æ–°å¢æŠ•å…¥, æœŸæœ«æƒç›Š\n";
        d.investors.forEach((inv) => {
          text += `${inv.name}, ${nf2(inv.initial)}, ${nf2(inv.profitShare)}, ${nf2(inv.added)}, ${nf2(inv.endEquity)}\n`;
        });

        // é¡ºä¾¿åœ¨è®°å½•é‡Œé™„ä¸Šä¸€ä¸ªå¯ç”¨çš„åˆ†äº«é“¾æ¥
        try {
          const base = window.location.href.split("?")[0];
          const shareData = {
            accountStart: g.accountStart,
            accountEnd: g.accountEnd,
            costsFromPnl: g.costsFromPnl,
            investorSharePercent: g.investorSharePercent,
            companyWage: g.companyWage,
            investors: d.investors.map((inv) => ({
              name: inv.name,
              initial: inv.initial,
              added: inv.added
            }))
          };
          const json = JSON.stringify(shareData);
          const encoded = encodeURIComponent(json);
          const link = `${base}?d=${encoded}`;
          text += "\nåˆ†äº«é“¾æ¥(å¯å¤åˆ¶åˆ°æµè§ˆå™¨æ‰“å¼€):\n" + link + "\n";
        } catch (e) {
          // å¿½ç•¥åˆ†äº«é“¾æ¥é”™è¯¯
        }

        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const fname = `fund_record_${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}_${pad2(dt.getHours())}${pad2(dt.getMinutes())}${pad2(dt.getSeconds())}.txt`;
        a.download = fname;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      // ä» URL ?d=... æ¢å¤é¡µé¢çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
      function loadFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const d = params.get("d");
        if (!d) return;

        try {
          const json = decodeURIComponent(d);
          const data = JSON.parse(json);

          if (typeof data.accountStart !== "undefined") {
            document.getElementById("accountStart").value = data.accountStart;
          }
          if (typeof data.accountEnd !== "undefined") {
            document.getElementById("accountEnd").value = data.accountEnd;
          }
          if (typeof data.costsFromPnl !== "undefined") {
            document.getElementById("costsFromPnl").value = data.costsFromPnl;
          }
          if (typeof data.investorSharePercent !== "undefined") {
            document.getElementById("investorShare").value = data.investorSharePercent;
          }
          if (typeof data.companyWage !== "undefined") {
            document.getElementById("companyWage").value = data.companyWage;
          }

          if (Array.isArray(data.investors)) {
            const tbody = document.querySelector("#investor-table tbody");
            tbody.innerHTML = "";
            data.investors.forEach((inv) => {
              addInvestorRow(
                inv.name || "",
                typeof inv.initial !== "undefined" ? inv.initial : "",
                typeof inv.added !== "undefined" ? inv.added : ""
              );
            });
          }

          // è‡ªåŠ¨è·‘ä¸€æ¬¡è®¡ç®—ï¼Œè®©æŠ•èµ„äººä¸€æ‰“å¼€å°±çœ‹åˆ°ç»“æœ
          runCalculation();
        } catch (e) {
          console.error("ä» URL åŠ è½½æ•°æ®å¤±è´¥", e);
        }
      }

      // é¡µé¢åŠ è½½æ—¶å°è¯•ä» URL æ¢å¤
      loadFromQuery();
    });
  </script>
</body>
</html>
